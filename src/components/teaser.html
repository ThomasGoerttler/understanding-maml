<div class="container">
    <div class="task"
         in:fly="{{ y: -400, duration: 200, easing: cubicIn }}"
         out:fly="{{ x: 400, duration: 200, easing: cubicOut }}"
         >

      <div class="columns is-mobile is-narrow">
        {#each current_sample as sample (sample.name)}
          <div class="column is-narrow"
            in:fly="{{ x: 200, duration: 200, easing: cubicIn }}"
            out:fly="{{ x: -200, duration: 200, easing: cubicOut  }}">
            <div class="card current_sample" draggable=true>
              <div class="card-image">
                <figure class="image is-square">
                  <img src={filename(sample)} alt={sample.name}>
                </figure>
              </div>
            </div>
          </div>
        {/each}
      </div>

      <div class="columns is-mobile is-multiline is-0 is-variable">
        {#each examples as example}
          <div class="column is-narrow">
            <div draggable=false class={`card class_card ${example.feedback_class}`} class:dragover={example.dragover}
                 on:drop={(event) => drop(event, example)}
                 on:click={(event) => drop(event, example)}
                 on:dragenter={(event) => dragEnter(event, example)}
                 on:dragleave={(event) => dragLeave(event, example)}
                 on:dragover={(event) => {event.preventDefault()}}
                 >
              <div class="card-image" draggable=false>
                <figure class="image is-square" draggable=false>
                  <img src={filename(example)} alt={example.name} draggable=false>
                </figure>
              </div>
            </div>
          </div>
        {/each}
      </div>
    </div>

  <div class="columns stats">
    <div class="column is-narrow">
      <span>{correct_guesses} out of {guesses}</span>
    </div>
    <div class="column is-narrow">
      <span>
        {#if guesses > 0}
          {(100 * correct_guesses / (guesses)).toFixed(1)}% accuracy
        {:else}
          drag sample onto one of the classes
        {/if}
      </span>
    </div>
  </div>
</div>


<script>
  import { fade, slide, fly } from 'svelte/transition';
  import { cubicIn, cubicOut } from 'svelte/easing';

  import range from 'lodash/range'
  import sample from 'lodash/sample'
  import padStart from 'lodash/padStart'
  import shuffle from 'lodash/shuffle'

  const num_classes = 964;

  let all_classes = range(1, num_classes + 1)
  let examples = []
  let samples = []

  let guesses = 0;
  let correct_guesses = 0;

  const pickRandom = samples => (
    samples.splice(
      // pick a random index, remove from list, and return picked sample
      Math.floor(Math.random() * samples.length), 1)[0]
  )

  for (let i=0; i < 5; i++) {
    // sample one of the remaining classes
    let c = pickRandom(all_classes)
    let cls = padStart(c, 4, '0')

    // create a representation for all class members
    let class_samples = range(1, 20 + 1).map(j => ({
      cls: cls,
      name: `${cls}_${padStart(j, 2, '0')}`
    }))

    let example = pickRandom(class_samples);
    example.dragover = false
    examples.push({...example, element: null})

    // add remaining samples to list of samples
    samples.push(...class_samples)
  }

  const filename = (x) => (
    `./img/omniglot/all_characters/${x.name.substr(0,2)}/${x.name.substr(2,2)}/${x.name}.png`
  )

  samples = shuffle(samples)


  // list allows us to fade out old and fade in new sample
  let current_sample = [samples.pop()];



  let dragEnter = (event, example) => {
    event.preventDefault();
    example.dragover = true
    console.log("dragenter", example)
    // mark as dirty
    examples = [...examples]
  }

  let dragLeave = (event, example) => {
    event.preventDefault();
    example.dragover = false
    // mark as dirty
    examples = [...examples]
  }

  let drop = (event, example) => {
    event.preventDefault();

    console.log(current_sample[0].cls == example.cls)
    guesses += 1
    if (current_sample[0].cls == example.cls) {
      correct_guesses += 1;
      example.feedback_class = "correct"
    } else {
      example.feedback_class = "incorrect"
    }

    setTimeout(() => {
      example.feedback_class = ""
      // mark as dirty
      examples = [...examples]
    }, 400)

    current_sample = [samples.pop()]

    example.dragover = false
    // mark as dirty
    examples = [...examples]
  }

</script>


<style>
  .container {
    border-top: 1px solid hsla(0, 0%, 0%, 0.1);
    text-align: center;
  }

  .columns:first-child {
    margin-top: .75rem;
  }

  .class_card {
    width: 105px;
    cursor: pointer;
  }


  /* For fast shadow animation */
  .class_card::before {
    content: ' ';
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;

    /*box-shadow: 0.1em 0.4em 8mm 0.4em RGBA(0,0,0,0), 0 0 0 1px RGBA(0,0,0,0);*/

    opacity: 0;
  }

  .class_card.correct::before {
    box-shadow: 0.1em 0.4em 8mm 0.4em RGBA(124,210,80,1), 0 0 0 1px RGBA(124,210,80,1);
    animation: pulse .3s ease-in-out;
  }

  .class_card.incorrect::before {
    box-shadow: 0.1em 0.4em 8mm 0.4em RGBA(207,46,46,1), 0 0 0 1px RGBA(207,46,46,1);
    animation: pulse .3s ease-in-out;
  }

  @keyframes pulse {
    0% {opacity: 0}
    50% {opacity: 1}
    100% {opacity: 0}
  }


  figure.image{
    margin-top: 0;
    margin-bottom: 0;
  }

  .class_card.dragover {
    box-shadow: 0 0.5em 1em -0.125em rgba(68, 1, 84, 0.5), 0 0 0 1px rgba(68, 1, 84, 0.12);
    background-color: rgba(68, 1, 84, 0.5);
  }

  .current_sample {
    width: 210px;
    background: none;
    cursor: grab;
  }

  .columns {
    justify-content: center;
  }

  .stats {
    font-size: 0.8em;
  }

</style>
