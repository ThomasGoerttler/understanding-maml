<Chart width=350 height=200>

  <Axis xDomain={[min_year-0.75, higher_year]} xTicks={[1+higher_year-min_year, 'd']}
        yDomain={[lower_accuracy, 1]} yTicks={[5, '%']}>

    {#each data as point, i}
      <Translate position={[point.year, point.accuracy]}>
        <circle cx=0 cy=0 r=2 fill="#689BAE"/>
        <text x="0" y={(i % 2) == 0 ? "0" : ".5em"} style="font-size: 6px" text-anchor="middle">
        {#each getLines(point.label, ((i % 2) == 0)) as line}
           <tspan x="0" dy={(i % 2) == 0 ? "-1.2em" : "1.2em"}>{line}</tspan>
        {/each}
        </text>
      </Translate>
    {/each}

    {#if user_acc != null}
      <Translate position={[thisYear, user_acc]}>
        <g transform="translate(-4, -4) scale(0.016717865)" fill="#f0c000">
          <path d="M477.795,184.279c-1.765-5.431-6.458-9.389-12.108-10.209l-147.159-21.384l-65.812-133.35
      			c-2.527-5.12-7.741-8.361-13.451-8.361s-10.924,3.241-13.451,8.361l-65.812,133.35L12.843,174.07
      			c-5.65,0.82-10.344,4.778-12.108,10.209c-1.765,5.43-0.293,11.391,3.796,15.376l106.484,103.798L85.877,450.018
      			c-0.965,5.627,1.349,11.314,5.968,14.671c4.618,3.354,10.741,3.799,15.797,1.142l131.623-69.199l131.623,69.199
      			c2.195,1.153,4.592,1.723,6.979,1.723c3.11,0,6.205-0.966,8.818-2.864c4.619-3.356,6.933-9.044,5.968-14.671l-25.138-146.565
      			l106.484-103.798C478.088,195.669,479.56,189.708,477.795,184.279z"/>
        </g>
        <text x="0" y="0" style="font-size: 6px" text-anchor="middle">
          <tspan x="0" dy="-1.2em">(5-way)</tspan>
          <tspan x="0" dy="-1.2em">Your score</tspan>
        </text>
      </Translate>
    {/if}
  </Axis>
</Chart>

<script>
  import {Chart, Axis, Translate} from './elements'
  import {userAccuracy} from './util/store'

  const thisYear = new Date().getFullYear()

  let data = [
    {
      year: 2011, accuracy: 0.549,
      label: "Generative\nStroke Model\n(20-way)",
      href: ""
    },
    {
      year: 2017, accuracy: .958,
      label: "MAML\n(20-way)",
      href: ""
    },
    {
      year: 2016, accuracy: .958,
      label: "Matching Nets\n(20-way)",
      href: ""
    },
    {
      year: 2015, accuracy: .938,
      label: "Siamese Nets\n(20-way)",
      href: ""
    },
    {
      year: 2013, accuracy: .962,
      label: "Hierarchial Bayesian\nProgram Learning\n(20-way)",
      href: ""
    }
  ]

  data.sort(p => p.year)

  const min_accuracy = 0.5
  const min_year = 2011
  const max_year = 2017

  let lower_accuracy = min_accuracy
  let higher_year = max_year


  let user_acc = null

  userAccuracy.subscribe((value) => {
    user_acc = value;

    if (user_acc != null) {
      lower_accuracy = Math.min(min_accuracy, user_acc)
      higher_year = thisYear

      // redraw points
      data = [...data]
    } else {
      lower_accuracy = min_accuracy
      higher_year = max_year

      // redraw points
      data = [...data]
    }
  })



  const getLines = (text, reverse=false) => {
    let lines = text.split('\n')
    if (reverse) {
      lines.reverse()
    }
    return lines
  }

</script>
